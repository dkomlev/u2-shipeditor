# Документация проекта U2 Ship Editor

## Назначение и запуск
U2 Ship Editor — статический набор инструментов для подготовки конфигураций кораблей и окружения U2 Flight Test. Его можно развернуть простым открытием `index.html` в браузере или запуском локального веб-сервера без дополнительных зависимостей.【F:README.md†L1-L9】

## Структура репозитория
| Путь | Назначение |
| --- | --- |
| `index.html` | Лаунчер стенда: выбор корабля, быстрые ссылки на редакторы и документацию.【F:index.html†L1-L175】 |
| `ship-architect.html` | Основной редактор ShipConfig с панелями авторасчётов, импортом/экспортом и подсказками по архетипам.【F:ship-architect.html†L1-L200】 |
| `app-config.html` | Конфигуратор AppConfig с живым предпросмотром и управлением секциями настроек симуляции.【F:app-config.html†L1-L54】 |
| `flight-test.html` | Страница симулятора Flight Test, подключающая движок, ассист и HUD-панели поверх канвы.【F:flight-test.html†L1-L160】 |
| `js/app.js` | Логика Ship Architect: состояние, биндинги UI, автоматические расчёты, рекомендации и управление ассистом.【F:js/app.js†L1-L160】【F:js/app.js†L593-L720】 |
| `js/home.js` | Скрипт лаунчера: загрузка манифеста, кэширование выбора корабля, импорт JSON и управление модальными окнами.【F:js/home.js†L1-L200】 |
| `js/app-config.js` | Управление редактором AppConfig: генерация форм из схемы, автосохранение, валидация и действия экспорта.【F:js/app-config.js†L1-L160】 |
| `js/schema.js` | Шаблон ShipConfig и справочники размеров/типов/пресетов, используемые приложением и тестами.【F:js/schema.js†L1-L103】 |
| `js/presets.js`, `js/nominals.js`, `js/validator.js` | Библиотеки архетипов ассиста, номинальных характеристик и проверки габаритов, задействованные авторасчётами редактора.【F:js/presets.js†L1-L120】【F:js/nominals.js†L1-L160】【F:js/validator.js†L1-L47】 |
| `js/lib/ship-adapter.js`, `js/lib/resources.js` | Адаптер ShipConfig 0.5.3/0.6 и сервис ресурсов, которые подготавливают сводки кораблей и читают манифесты.【F:js/lib/ship-adapter.js†L1-L200】【F:js/lib/resources.js†L1-L120】 |
| `js/sim/` | Физическое ядро, контроллеры и пилот-ассист, используемые в Flight Test для обработки входа и динамики корабля.【F:js/sim/core.js†L1-L120】【F:js/sim/pilot-assist.js†L1-L152】 |
| `ships/` | Каталог ShipConfig и `manifest.json`, откуда лаунчер подгружает корабли и метаданные.【F:ships/manifest.json†L1-L120】 |
| `scripts/` | Вспомогательные утилиты CLI: пересборка манифеста, валидация конфигов, миграции и балансировка характеристик.【F:scripts/build-manifest.cjs†L1-L78】【F:scripts/validate-ships.js†L1-L59】 |
| `test/` | Автотесты (smoke-тест) для проверки схемы ShipConfig через Ajv и `buildEmptyConfig`.【F:test/smoke.js†L1-L36】 |

## Веб-интерфейсы
### Лаунчер (index.html + js/home.js)
Главная страница отображает статус стенда, карточки действий и список характеристик выбранного корабля. Она подключает сервисы `U2ShipAdapter` и `U2Resources`, чтобы загрузить `ships/manifest.json`, восстановить выбор из `localStorage` и разрешать импорт JSON-файлов через модальное окно выбора корабля. Управление пресетом ассиста выполняется через селектор с сохранением в сторидж и синхронизацией с отображаемой сводкой.【F:index.html†L24-L170】【F:js/home.js†L3-L200】【F:js/lib/resources.js†L11-L79】【F:ships/manifest.json†L1-L120】

### Ship Architect (ship-architect.html + js/app.js)
Редактор ShipConfig предоставляет карточки по разделам (классификация, спрайт, геометрия, сигнатуры, производительность и т.д.), инструменты авторасчётов и подсказок. Скрипт `js/app.js` инициализирует состояние корабля через `buildEmptyConfig`, привязывает элементы к полям JSON, регистрирует кнопки автоматизации и подсветку проблем. Автофункции рассчитывают тягу, радиус корпуса, массу, инерцию, параметры ассиста и производительности на основе номиналов и валидаторов, сохраняя события в журнале статуса и выделяя поля с предупреждениями.【F:ship-architect.html†L10-L200】【F:js/app.js†L1-L160】【F:js/app.js†L561-L720】【F:js/validator.js†L1-L47】【F:js/nominals.js†L6-L160】

### Редактор AppConfig (app-config.html + js/app-config.js)
Инструмент «Настройки Вселенной» строит интерфейс из определения секций `SECTION_DEFS`, позволяя настраивать мир, физику, визуальные подсказки, HUD, ввод и прочие параметры. Скрипт импортирует библиотеку `U2AppConfig`, поддерживает автосохранение в `localStorage`, валидацию полей (например, скорость света), импорт/экспорт JSON и управление предпросмотром сцены через холст справа.【F:app-config.html†L10-L48】【F:js/app-config.js†L3-L118】

### Flight Test (flight-test.html + js/sim/*)
Страница симулятора создаёт канву с HUD-панелями и подключает загрузчик конфигураций, адаптер кораблей, ресурсный сервис и физический стек (`core`, `input`, `coupled-controller`, `pilot-assist`, `collision`, `asteroids`). Физическое ядро `createState/step` рассчитывает поступательные и угловые параметры с учётом тяги и ограничений, а пилот-ассист формирует команды управления, режимы (coupled/decoupled/brake) и телеметрию на основании сводки ассиста корабля.【F:flight-test.html†L131-L160】【F:js/sim/core.js†L9-L86】【F:js/sim/pilot-assist.js†L3-L150】

## Логика Ship Architect
* **Состояние и биндинги.** Приложение хранит текущий ShipConfig, логи статуса и настройки UI, связывая DOM-элементы через `data-bind` и `data-text`. Изменения полей мгновенно записываются в объект корабля, вызывая постобработку (нормализацию, синхронизацию классификации) и перерисовку.【F:js/app.js†L8-L160】
* **Автоматизация.** Кнопки Auto/Recommend/Nominal запускают набор утилит: расчёт тяги и RCS по массе и ускорению, пересчёт радиуса, массы, инерции и питания, подстройка ассиста к физике и шаблонам архетипов. Все операции логируются и подсвечивают соответствующие поля в интерфейсе.【F:js/app.js†L593-L720】
* **Проверки и подсказки.** Валидация размеров использует таблицу диапазонов по классам, предлагая лучший размер при выходе за пределы, а номиналы хранят эталонные характеристики для автозаполнения и рекомендаций.【F:js/validator.js†L1-L47】【F:js/nominals.js†L6-L160】
* **Работа со спрайтами и журналом.** Интерфейс управляет загрузкой/очисткой спрайта, сканированием прозрачности и ведёт журнал последних действий, отображая их в отдельной панели.【F:js/app.js†L36-L160】【F:js/app.js†L561-L608】

## Адаптеры и данные
* **ShipAdapter.** Библиотека выравнивает различия между версиями 0.6 и 0.5.3: вычисляет архетип, ускорения, тяговооружённость, рекомендации по ассисту и метаданные для отображения в лаунчере и симуляторе.【F:js/lib/ship-adapter.js†L105-L200】
* **U2Resources.** Сервис кеширует манифест и ShipConfig, нормализует записи (например, копирует ассист и акселерации в summary) и предоставляет API `loadManifest/getShipSummary` для UI.【F:js/lib/resources.js†L11-L120】
* **Каталог ships.** `manifest.json` содержит готовые ShipConfig-резюме с путями, типами, ускорениями и профилями ассиста, которые использует лаунчер для быстрого отображения характеристик и фильтрации по тегам (например, stealth).【F:ships/manifest.json†L1-L120】

## CLI-утилиты и тесты
* `scripts/build-manifest.cjs` рекурсивно собирает все `*-config.json`, прогоняет через ShipAdapter и пересобирает `ships/manifest.json`, сохраняя агрегированные характеристики (ускорения, тяга, ассист).【F:scripts/build-manifest.cjs†L7-L66】
* `scripts/validate-ships.js` проверяет каждый ShipConfig против схемы Ajv, выводя ошибки и общее количество успешных файлов, что позволяет удерживать совместимость с текущей версией шаблона.【F:scripts/validate-ships.js†L1-L59】
* `test/smoke.js` — минимальный тест, который строит пустой конфиг через `buildEmptyConfig()` и валидирует его по схеме ShipConfig после смягчения обязательных полей, гарантируя синхронизацию шаблона и схемы.【F:test/smoke.js†L1-L36】

## Рекомендации по работе
1. **Редактирование ShipConfig.** Используйте Ship Architect: загрузите существующий JSON, примените автозаполнение номиналами и проверьте предупреждения по габаритам перед экспортом.【F:ship-architect.html†L45-L200】【F:js/app.js†L593-L720】
2. **Обновление каталога кораблей.** После добавления новых `*-config.json` в `ships/` запустите `scripts/build-manifest.cjs` и при необходимости `scripts/validate-ships.js`, чтобы актуализировать манифест и убедиться в корректности схемы.【F:scripts/build-manifest.cjs†L59-L66】【F:scripts/validate-ships.js†L34-L59】
3. **Проверка схемы.** Перед публикацией изменений выполните `npm test` (запускает smoke-тест Ajv), чтобы убедиться, что базовый шаблон ShipConfig остаётся валидным.【F:package.json†L6-L12】【F:test/smoke.js†L1-L36】
