# U2 — ТЗ страницы «Редактор AppConfig»

## 1. Назначение

Единая страница для редактирования настроек симуляции и клиента: мир, отрисовка, HUD, ввод, столкновения, астероиды, автопилот, отладка, пути к ресурсам. Ключевые переключатели: **координатная сетка**, **астероиды**, **скорость света**.

## 2. Область действия и версии

- Поддерживаем **AppConfig v0.5.3+**. Допускается «расширенный» блок `physics` без нарушения обратной совместимости.
- Не изменяем формат ShipConfig. В поле `paths.ship_config_path` только читаем/редактируем путь.

## 3. Основные сценарии (MVP)

1. Пользователь включает/выключает **сетку координат** и видит мгновенное обновление предпросмотра.
2. Пользователь включает/выключает **астероиды** и задаёт их параметры (количество/плотность/радиусы) с предпросмотром.
3. Пользователь изменяет **скорость света** и видит подсказки о влиянии на симуляцию. Значение сохраняется в конфиге.
4. Импорт/экспорт `AppConfig` в JSON, откат к дефолтам, запуск Flight Test с текущими настройками.

## 4. Архитектура страницы

- **Макет:**
  - Левая колонка (sidebar): разделы настроек.
  - Центральная область: форма раздела.
  - Правая колонка: **Live Preview** (мини-сцена 2D) и сводка текущих значений.
- **Верхняя панель действий:** Сохранить, Сбросить по разделу, Импорт, Экспорт, Поехали! (запуск Flight Test).
- **Автосохранение:** локально в `localStorage` каждые 1 с при изменениях, явная кнопка «Сохранить в файл» для выгрузки.

## 5. Структура AppConfig (v0.5.3+)

```json
{
  "version": "0.5.3",
  "paths": {
    "ship_config_path": "string"
  },
  "world": {
    "seed": 0,
    "bounds": {"width": 1000000, "height": 1000000}
  },
  "physics": {                 // расширение 0.5.3+
    "c_mps": 10000,            // скорость света в м/с (по умолчанию 10000 = 10 км/с)
    "dt_sec": 0.0166667,       // шаг интегрирования
    "max_time_scale": 1        // ограничение ускорения времени (при необходимости)
  },
  "render": {
    "background": "#000814",
    "grid": {"enabled": true, "cell": 1000, "thickness": 1, "alpha": 0.15},
    "sprites": {"antialias": true}
  },
  "hud": {
    "show_fps": true,
    "show_coords": true,
    "show_velocity": true
  },
  "input": {
    "bindings": {"thrust_fwd": "W", "thrust_back": "S", "strafe_left": "A", "strafe_right": "D", "roll_left": "Q", "roll_right": "E"},
    "mouse_sensitivity": 1.0
  },
  "collision": {
    "mode": "AABB",          // AABB | ALPHA
    "debug_draw": false
  },
  "asteroids": {
    "enabled": true,
    "count": 250,
    "radius_min": 12,
    "radius_max": 60,
    "field": {"width": 120000, "height": 120000}
  },
  "autopilot": {
    "enabled_on_start": true,
    "mode": "Random"
  },
  "logging": {"level": "info"},
  "debug": {"developer_overlays": false}
}
```

> Примечание: если в существующем AppConfig нет блока `physics`, редактор добавляет его при сохранении. Старые поля, не известные редактору, сохраняются без удаления.

## 6. Ключевые параметры и UI-контролы

### 6.1 Скорость света (`physics.c_mps`)

- **Контролы:** числовое поле (м/с), слайдер (логарифмический), пресеты.
- **Пресеты:**
  - Реальная: `299792458` м/с.
  - Игровая (по умолчанию): `10000` м/с.
  - Экспериментальная: `1000` м/с.
- **Валидация:** `1000 ≤ c_mps ≤ 299792458`. Шаг: адаптивный по порядку величины.
- **Подсказки в UI:**
  - «Максимальная безопасная скорость корабля ограничена < 0.99·c.»
  - «Параметры оружия и навигации должны учитываться с учётом выбранного c.»
- **Эффекты предпросмотра:** шкала скоростей пересчитывается, маркеры 0.1c, 0.5c, 0.9c.

### 6.2 Координатная сетка (`render.grid.enabled`)

- **Контрол:** переключатель On/Off.
- **Параметры:** размер клетки, толщина линии, прозрачность.
- **Предпросмотр:** мгновенное включение/выключение, отображение подписей осей при наведении.

### 6.3 Астероиды (`asteroids.enabled`)

- **Контрол:** переключатель On/Off.
- **Параметры:** количество, минимальный/максимальный радиус, размер поля.
- **Предпросмотр:** генерация стохастического распределения точек-заменителей; кнопка «Перегенерировать сид».
- **Ограничения производительности:** предупреждение при `count > 1000`.

### 6.4 Столкновения (`collision.mode`)

- **Опции:** `AABB` (по умолчанию) или `ALPHA`.
- **Подсказка:** `ALPHA` требует корректно загруженных текстур без CORS-проблем; иначе редактор принудительно вернёт `AABB`.

### 6.5 HUD

- Переключатели FPS/координаты/скорость. Предпросмотр иконок-индикаторов.

### 6.6 Ввод (`input.bindings`)

- Ребайндинг по клику, сброс к дефолту. Конфликтные бинды подсвечиваются.

### 6.7 Автопилот (`autopilot`)

- Включён по умолчанию. Режимы: `Random`, `Hold`, `Orbit` (задавать цель в последующих версиях).

### 6.8 Пути (`paths.ship_config_path`)

- Поле выбора файла/пути. Проверка доступности.

## 7. Live Preview

- Мини-сцена 2D в правой колонке: камера, сетка, тестовые точки астероидов, индикатор текущего `c` и маркеры долей `c`.
- Предпросмотр не запускает полную физику боя, только визуальные реперы.

## 8. Механика сохранения

- **Локально:** изменения буферизуются в памяти и `localStorage`.
- **В файл:** Экспорт JSON. Импорт JSON с валидацией против схемы.
- **Сброс:** до дефолтов по разделу или по всему документу.

## 9. Схема валидации (сводно)

- `physics.c_mps`: число, диапазон [1e3; 299792458].
- `render.grid.cell`: целое ≥ 10.
- `asteroids.count`: целое [0; 5000].
- `asteroids.radius_min ≤ radius_max`.
- `collision.mode ∈ {AABB, ALPHA}`.
- `input.bindings`: все команды должны быть назначены; дубли — предупреждение.

## 10. Запуск Flight Test

- Кнопка **«Поехали!»** формирует in-memory AppConfig и открывает стенд.
- Конфиг передаётся без потери неизвестных полей.

## 11. НФ-требования

- Отзывчивость UI: до 50 мс на изменение любого тумблера.
- Предпросмотр: ≤ 120 FPS при `asteroids.count ≤ 1000`.
- Доступность: управление с клавиатуры, контраст ≥ WCAG AA.
- i18n: RU/EN.

## 12. Критерии приёмки

1. Переключатель **«Показывать сетку»** меняет предпросмотр и записывается в `render.grid.enabled`.
2. Переключатель **«Астероиды»** управляет `asteroids.enabled`; параметры применяются и валидируются.
3. Изменение **`physics.c_mps`** проходит валидацию, отображает подсказки и сохраняется в JSON.
4. Импорт/экспорт корректно восстанавливает все разделы, в т. ч. незнакомые редактору поля.
5. Кнопка **«Поехали!»** запускает симулятор с текущим AppConfig.

