# U2 — ТЗ FlightTest v0.5.3

## 0. Цель и состав

Техническое задание на плейтест **FlightTest v0.5.3** для U2. Документ фиксирует поведение симуляции, управление (ПК/мобайл), коллизии, генерацию окружения, HUD, **автопилот Random** и тест‑набор. **Конфиг‑архитектура раздельная:**

* `app.json` — мир/отрисовка/HUD/управление/коллизии/логирование/отладка + `paths.ship_config_path` (см. «U2 — ТЗ AppConfig v0.5.3 (canonical)»)
* `ship.json` — все ТТХ корабля (масса, геометрия, спрайт, движители, g‑лимиты, ассисты) (см. «U2 — ТЗ ShipConfig v0.5.3 (ТЗ + Presets)»)

> Конфиги читаются **только при запуске**. Горячая смена корабля не поддерживается. Сокращение проекта — **U2**.

---

## 1. Базис симуляции

* Временной шаг: `dt = 1/tick_rate_hz`, по умолчанию **60 Гц** (из `app.json/world.tick_rate_hz`).
* Предел «медленного света»: `c'` (**1000 м/с** для первых тестов; `app.json/world.c_prime`).
* Пространство: тороидальное поле `bounds_rect_m` с wrap‑around; телеметрия ведётся в СИ (м, м/с, рад, кг).

### 1.1. Релятивистские клампы (SR‑приближение)

* Продольное ускорение вдоль вектора скорости ограничивается `/γ³`, поперечное — `/γ`.
* Итоговое ускорение = `min(тяга/м, SR‑клампы, g_limits)` по соответствующим осям.
* Формула: `γ = 1 / sqrt(1 − (|v|/c')²)`; при `|v| ≥ 0.999·c'` численно клампим `|v|` для устойчивости.

### 1.2. Система координат и углы

* Оси экрана/мира: `+X` — вправо, `+Y` — вверх.
* Угол курса `theta` отсчитывается от оси `+X`; положительное направление — против часовой стрелки (CCW).
* Угловая скорость `omega` > 0 соответствует вращению CCW.

---

## 2. Управление (ПК)

Карта клавиш фиксированная (см. `app.json/input.keys`):

* **Тяга вперёд/назад:** `W/S`
* **Стрейф влево/вправо:** `A/D`
* **Поворот влево/вправо:** `Q/E`
* **Торможение (Brake ассист):** `Space`
* **Coupled/Decoupled:** `C` (переключение)
* **Автопилот (Random):** `R` — **переключение (вкл/выкл)**; по умолчанию активен сразу после старта приложения. Любой ручной ввод (клавиатура/тач) отключает режим; повторное `R` включает снова. Режим автопилота не изменяет состояние Coupled/Decoupled.
* **Зум:** `+` / `-`
* **Коллизии:** `F2` — режим AABB/Alpha; `F3` — показать/скрыть оверлей
* **Сервис:** `F12` — скриншот

### 2.1. Coupled vs Decoupled

* **Coupled (по умолчанию):** ассист выравнивает нос к вектору движения («управляемый занос»). Ограничения `coupled_omega_cap_radps`, `coupled_alpha_cap_radps2` берутся из `ship.json/assist`. Ручной поворот (Q/E) ограничен `ship.json/rcs.turn_*`. **Итоговые пределы ω/α в Coupled:** `min(assist.coupled_*, rcs.turn_*)`.
* **Decoupled:** ориентация не привязана к вектору скорости; действуют только `ship.json/rcs.turn_*` и SR‑клампы.

---

## 3. Управление (мобайл)

Схема `dual_stick` (см. `app.json/input.touch`). На мобильных **нет UI‑кнопок** для маски/режима коллизий (F2/F3 доступны только на ПК).

* Левый стик — тяга/стрейф (оси)
* Быстрый «нос» (pad) — поворот
* Удержание ≥`hold_to_enable_ms` на pad — временный Decoupled; двойной тап — фиксация Decoupled
* Отпускание стика — опциональный автотормоз (если `brake_on_release`). Кнопка **Brake** (мобайл) эквивалентна `Space` на ПК: включает ассист плавного торможения до |v|→0 с учётом SR‑клампов и g‑лимитов, **без изменения** состояния Coupled/Decoupled. Нажатие Brake **не снимает** фиксацию Decoupled.

**Safe area и ориентация:** при смене ориентации экрана safe area пересчитывается, все элементы `layout.*` позиционируются в процентах относительно актуальной safe‑области.

**Автопилот (мобайл):** при старте активен; первый любой жест/ввод отключает режим. Отдельной UI‑кнопки для повторного включения в v0.5.3 нет.

**Зум на мобайле:** кнопки `zoom_plus`/`zoom_minus` изменяют масштаб в пределах `render.zoom.min..max` (см. AppConfig). Один тап — изменение на **10%** диапазона зума; удержание — авто‑повтор ~ **100 мс** до достижения пределов. Значения клампятся в [min,max] и отражаются в HUD.

---

## 4. Коллизии и оверлей

* **Режимы:** `AABB` (ось‑aligned bbox) и `Alpha` (маска непрозрачных пикселей спрайта корабля/астероида при `alpha ≥ alpha_thr`).
* **Переключение:** `F2` — режим; `F3` — показать/скрыть оверлей. На старте — как в `app.json/collision` (`mode_default`, `overlay_visible_default`).
* **Фоллбек:** при «tainted canvas» **и/или** вне диапазона зума → автоматический `AABB` (см. `collision.fallback_threshold`).
* **Визуализация:** цвет/прозрачность из `collision.mask`; порог альфы берётся из `ship.json/sprite.alpha_thr`. Альфа‑маска каждого спрайта вычисляется один раз на старте и кэшируется.

**Уточнение AABB и границ:** AABB трактуется как *мировая осевая* bbox вокруг ориентированного спрайта (поворот спрайта учитывается, но коробка остаётся осевой в координатах мира XY). При wrap‑around проверка коллизий выполняется **на всех топологических образах** объекта, которые пересекают `bounds_rect_m`, чтобы исключить туннелирование через шов.

---

## 5. Геометрия корабля и спрайт

Полная спецификация геометрии, осей и соответствия маске спрайта находится в **«U2 — ТЗ ShipConfig v0.5.3» (§3 Geometry)**. В FlightTest фиксируется только правило валидации: tight‑bbox по маске (`alpha ≥ alpha_thr`) через `m_per_px` должен совпадать с `ship.json/geometry.bbox_m` в допустимом допуске. Пример 25.0×20.5 м относится **только к тестовому истребителю** и не переопределяет данные из `ship.json` других кораблей.

---

## 6. Астероиды

* Генерация по `app.json/asteroids`: покрытие, диапазон радиусов, плотность (камень по умолчанию 2700 кг/м³), распределение `lognormal|uniform` (усечённое).
* **Столкновения:** при контакте корабль уничтожается; масса астероида уменьшается: `M' = max(M − m_ship, 0)`. Радиус пересчитывается из объёма: `r' = r · (M'/M)^(1/3)`.
* `margin_m` предотвращает спавны в зоне старта и у границ.

---

## 7. Перезапуск/смерть

* Game Over при столкновении (корабль уничтожен); Restart возвращает мировой стейт к началу: корабль — в стартовой позиции/ориентации/скоростях; UI — к дефолтам; зум — к `render.zoom.start`.
* Грейс после спавна: `ship.json/spawn.spawn_grace_seconds` (по умолчанию 2.0 с).

**Что именно сбрасывается при Restart:** позиция/скорость/угол/угловая скорость корабля; состояние ассистов (Coupled=ON); режим коллизий = `collision.mode_default`; видимость оверлея = `collision.overlay_visible_default`; зум = `render.zoom.start`; **состояние автопилота = ****`autopilot.random_enabled_default`**.

**Логирование Restart:** в момент Restart в лог добавляется запись с текущими флагами `collision_mode`, `overlay_visible`, `coupled`.

---

## 8. HUD и телеметрия

* Компактный HUD с адаптацией к ориентации; безопасные поля — `hud.safe_insets_px`.
* Показатели: скорость `|v|`, `γ`, `|a|/g`, статус Coupled.
* Логи (если включены): `t,x,y,vx,vy,|v|,gamma,ax,ay,|a|/g,theta,omega,zoom…` (см. `app.json/logging`).

**Единицы телеметрии:** `x,y` — м; `vx,vy,|v|` — м/с; `ax,ay` — м/с²; `|a|/g` — безразмерное (g0=9.80665 м/с²); `theta` — рад; `omega` — рад/с; `gamma` — безразмерное. Диапазон `theta` — (−π, π], ноль по +X, положительное направление — CCW.

---

## 9. Тест‑набор (приёмка)

**FF‑серия (функциональные):**

* **FF1:** переключение AABB/Alpha (`F2`), оверлей (`F3`), видимость/цвет соответствуют `app.json/collision`.
* **FF2:** Coupled: выравнивание носа к вектору скорости при произвольных входах; пределы ω/α соблюдают `assist.coupled_*` и `rcs.turn_*`.
* **FF3:** Decoupled: ориентация полностью независима от траектории; соблюдаются SR‑клампы.
* **FF4:** Столкновение с астероидом уничтожает корабль; радиус астероида уменьшается по формуле из §6.
* **FF5:** Restart: стейт сброшен; зум = `render.zoom.start`; wrap‑around работает корректно.
* **FF6:** **Автопилот Random:** активен по умолчанию; отключается на первый ручной ввод; клавиша `R` — **toggle** (повторное `R` включает снова); действует в рамках SR‑клампов и g‑лимитов; не меняет Coupled/Decoupled.

**MF‑серия (мобайл):**

* **MF1:** dual_stick: оси тяги/стрейфа и поворот через pad работают, deadzone/чувствительность — по конфигу.
* **MF2:** Удержание pad ≥ `hold_to_enable_ms` — временный Decoupled; двойной тап — фиксация; отпускание стика — Brake (если включён). Нажатие Brake не влияет на режим Coupled/Decoupled и не снимает фиксацию.
* **MF3:** Нет UI‑кнопок для маски/режима; F‑клавиши вне мобайла.

**PP‑серия (производительность):**

* **PP1:** Инициализация альфа‑маски 512×512 ≤ 50 мс на стенд‑пресете (CPU i5‑8250U/экв., RAM 8 GB, Chrome 120+/Firefox 121+, Canvas 1920×1080).
* **PP2:** При `asteroids.coverage_fraction = 0.015` и `render.target_fps = 60` медианный FPS ≥ 55; просадки ниже 50 FPS длятся не более 100 мс подряд на стенд‑пресете. Стенд‑профиль выбирается из `debug.benchmark_profile` (см. AppConfig).

---

## 10. Совместимость и границы ответственности

* Все ключи мира/UI/управления/коллизий/логов/отладки живут в `app.json`. Любые `ship.*`/`assist.*`/`g_limits.*` в `app.json` игнорируются с **лог‑предупреждением** и не влияют на рантайм (см. AppConfig‑ТЗ).
* Все ТТХ корабля (включая g‑лимиты и ассисты) живут в `ship.json`.
* Клавиша `R` относится к **автопилоту**; функции «randomize asteroids/seed++» из дебаг‑конфигов **удалены в v0.5.3** или доступны только из внутренних инструментов.

---

## 11. Ссылки и версии

* **U2 — ТЗ AppConfig v0.5.3 (canonical)**
* **U2 — ТЗ ShipConfig v0.5.3 (ТЗ + Presets)**
* **U2 — App Config Presets (v0.5.3)**

### LEGACY (не использовать)

* Любые версии документов с сокращением «UU» вместо «U2»
* Любые версии FlightTest до v0.5.3 и редакции без раздела об автопилоте

---

## 12. Глоссарий

* **Coupled/Decoupled** — режимы ассиста ориентации.
* **AABB/Alpha** — модели коллизий: прямоугольник / маска прозрачности.
* **γ (гамма)** — фактор Лоренца в SR‑приближении.
* **pivot** — опорная точка спрайта.
* **wrap‑around** — тороидальный мир: выход за границу переносит на противоположную сторону.
* **tainted canvas** — состояние Canvas2D, при котором недоступны операции чтения пикселей (`getImageData`) из‑за рисования кросс‑доменных изображений без корректных CORS‑заголовков/учётных данных или из небезопасных источников. При обнаружении таинта коллизии автоматически переводятся в режим **AABB** (см. §4 фоллбек).
